define("plugins/history",["durandal/system"],function(e){function t(e,t,a){if(a){var n=e.href.replace(/(javascript:|#).*$/,"");e.replace(n+"#"+t)}else e.hash="#"+t}var a=/^[#\/]|\s+$/g,n=/^\/+|\/+$/g,r=/msie [\w.]+/,o=/\/$/,i={interval:50,active:!1};return"undefined"!=typeof window&&(i.location=window.location,i.history=window.history),i.getHash=function(e){var t=(e||i).location.href.match(/#(.*)$/);return t?t[1]:""},i.getFragment=function(e,t){if(null==e)if(i._hasPushState||!i._wantsHashChange||t){e=i.location.pathname;var n=i.root.replace(o,"");e.indexOf(n)||(e=e.substr(n.length))}else e=i.getHash();return e.replace(a,"")},i.activate=function(t){if(i.active)throw new Error("History has already been activated.");i.active=!0,i.options=e.extend({},{root:"/"},i.options,t),i.root=i.options.root,i._wantsHashChange=i.options.hashChange!==!1,i._wantsPushState=!!i.options.pushState,i._hasPushState=!!(i.options.pushState&&i.history&&i.history.pushState);var o=i.getFragment(),s=document.documentMode,h=r.exec(navigator.userAgent.toLowerCase())&&(!s||7>=s);i.root=("/"+i.root+"/").replace(n,"/"),h&&i._wantsHashChange&&(i.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,i.navigate(o)),i._hasPushState?$(window).on("popstate",i.checkUrl):i._wantsHashChange&&"onhashchange"in window&&!h?$(window).on("hashchange",i.checkUrl):i._wantsHashChange&&(i._checkUrlInterval=setInterval(i.checkUrl,i.interval)),i.fragment=o;var c=i.location,l=c.pathname.replace(/[^\/]$/,"$&/")===i.root;return i._wantsHashChange&&i._wantsPushState&&!i._hasPushState&&!l?(i.fragment=i.getFragment(null,!0),i.location.replace(i.root+i.location.search+"#"+i.fragment),!0):(i._wantsPushState&&i._hasPushState&&l&&c.hash&&(i.fragment=i.getHash().replace(a,""),i.history.replaceState({},document.title,i.root+i.fragment+c.search)),i.options.silent?void 0:i.loadUrl())},i.deactivate=function(){$(window).off("popstate",i.checkUrl).off("hashchange",i.checkUrl),clearInterval(i._checkUrlInterval),i.active=!1},i.checkUrl=function(){var e=i.getFragment();return e===i.fragment&&i.iframe&&(e=i.getFragment(i.getHash(i.iframe))),e===i.fragment?!1:(i.iframe&&i.navigate(e),i.loadUrl()||i.loadUrl(i.getHash()),void 0)},i.loadUrl=function(e){var t=i.fragment=i.getFragment(e);return i.options.routeHandler?i.options.routeHandler(t):!1},i.navigate=function(e,a){if(!i.active)return!1;if(a&&a!==!0||(a={trigger:a}),e=i.getFragment(e||""),i.fragment!==e){i.fragment=e;var n=i.root+e;if(i._hasPushState)i.history[a.replace?"replaceState":"pushState"]({},document.title,n);else{if(!i._wantsHashChange)return i.location.assign(n);t(i.location,e,a.replace),i.iframe&&e!==i.getFragment(i.getHash(i.iframe))&&(a.replace||i.iframe.document.open().close(),t(i.iframe.location,e,a.replace))}return a.trigger?i.loadUrl(e):void 0}},i});